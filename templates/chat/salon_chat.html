{% extends 'base.html' %}
{% load static %}

{% block title %}{{ salon.nom }} - Chat - Jessna TechLearn{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .message-bubble {
        animation: slideInMessage 0.3s ease-out;
    }
    
    @keyframes slideInMessage {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .typing-indicator {
        animation: pulse 1.5s infinite;
    }
    
    .online-indicator {
        animation: pulse 2s infinite;
        background: #10b981;
    }
    
    .chat-input:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .sidebar {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-left: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .message-own {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .message-other {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
    }
    
    .chat-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Responsive Mobile */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            height: 100vh;
            width: 85%;
            max-width: 320px;
            z-index: 50;
            transition: right 0.3s ease;
            border-left: none;
            border-radius: 0;
        }
        
        .sidebar.open {
            right: 0;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .message-bubble {
            margin: 0 8px;
        }
        
        .chat-header {
            padding: 12px 16px;
        }
        
        .chat-messages {
            padding: 16px 8px;
        }
        
        .chat-input-container {
            padding: 12px 16px;
        }
    }
    
    @media (max-width: 480px) {
        .message-bubble .flex {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .message-bubble.justify-end .flex {
            align-items: flex-end;
        }
        
        .message-own, .message-other {
            max-width: 85%;
        }
        
        .chat-header h1 {
            font-size: 1.125rem;
        }
        
        .chat-header p {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-purple-900">
    <!-- Overlay pour mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="flex h-screen">
        <!-- Zone de chat principale -->
        <div class="flex-1 flex flex-col">
            <!-- Header du salon -->
            <div class="chat-header p-4 flex items-center justify-between">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="{% url 'chat:liste_salons' %}" 
                       class="text-gray-500 hover:text-indigo-600 transition-colors">
                        <i class="fas fa-arrow-left text-lg sm:text-xl"></i>
                    </a>
                    
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-lg">
                            {{ salon.nom|first|upper }}
                        </div>
                        <div class="min-w-0 flex-1">
                            <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white truncate">
                                {{ salon.nom }}
                            </h1>
                            <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 truncate">
                                {{ salon.participants.count }} membre{{ salon.participants.count|pluralize }}
                                <span class="hidden sm:inline">
                                    • <span class="text-green-500">
                                        <i class="fas fa-circle text-xs mr-1"></i>
                                        En ligne
                                    </span>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-1 sm:space-x-3">
                    <button class="hidden sm:block p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Rechercher">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="hidden sm:block p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Informations">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="p-2 text-gray-500 hover:text-indigo-600 transition-colors md:hidden" 
                            onclick="toggleSidebar()" title="Membres">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="hidden sm:block p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Paramètres">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-2 sm:p-4 space-y-3 sm:space-y-4 chat-messages" id="chat-messages">
                {% for message in messages %}
                <div class="message-bubble flex items-start space-x-2 sm:space-x-3 {% if message.auteur == user %}justify-end{% endif %}">
                    {% if message.auteur != user %}
                    <img src="{% if message.auteur.userprofile %}{{ message.auteur.userprofile.get_avatar_url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}" 
                         alt="{{ message.auteur.username }}" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex-shrink-0">
                    {% endif %}
                    
                    <div class="{% if message.auteur == user %}text-right{% else %}flex-1 min-w-0{% endif %}">
                        <div class="flex items-center {% if message.auteur == user %}justify-end{% endif %} space-x-1 sm:space-x-2 mb-1">
                            {% if message.auteur != user %}
                            <span class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate">
                                {{ message.auteur.get_full_name|default:message.auteur.username }}
                            </span>
                            {% endif %}
                            <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">
                                {{ message.timestamp|date:"H:i" }}
                            </span>
                            {% if message.auteur == user %}
                            <span class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white">Vous</span>
                            {% endif %}
                        </div>
                        
                        <div class="{% if message.auteur == user %}message-own text-white{% else %}message-other text-gray-800 dark:text-gray-200{% endif %} rounded-2xl {% if message.auteur == user %}rounded-tr-md{% else %}rounded-tl-md{% endif %} p-2 sm:p-3 shadow-sm {% if message.auteur == user %}inline-block max-w-xs sm:max-w-sm{% else %}max-w-xs sm:max-w-md{% endif %} break-words">
                            <p class="text-sm sm:text-base">{{ message.contenu }}</p>
                        </div>
                    </div>
                    
                    {% if message.auteur == user %}
                    <img src="{% if user.userprofile %}{{ user.userprofile.get_avatar_url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}" 
                         alt="Votre avatar" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex-shrink-0">
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comments text-2xl text-white"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                        Aucun message pour le moment
                    </h3>
                    <p class="text-gray-600 dark:text-gray-300">
                        Soyez le premier à envoyer un message dans ce salon !
                    </p>
                </div>
                {% endfor %}

                <!-- Indicateur de frappe -->
                <div id="typing-indicator" class="typing-indicator flex items-center space-x-3 hidden">
                    <img src="{% static 'images/default_avatar.png' %}" 
                         alt="Avatar" class="w-8 h-8 rounded-full">
                    <div class="message-other rounded-2xl rounded-tl-md p-3 shadow-sm">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div class="chat-header p-3 sm:p-4 chat-input-container">
                <form id="message-form" method="post" action="{% url 'chat:envoyer_message' salon.id %}">
                    {% csrf_token %}
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <button type="button" class="hidden sm:block p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Joindre un fichier">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        <button type="button" class="hidden sm:block p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Ajouter une image">
                            <i class="fas fa-image text-lg"></i>
                        </button>
                        <div class="flex-1 relative">
                            <input type="text" 
                                   name="contenu"
                                   class="chat-input w-full px-3 sm:px-4 py-2 sm:py-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm sm:text-base text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                   placeholder="Tapez votre message..."
                                   id="message-input">
                            <button type="button" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 sm:p-2 text-gray-500 hover:text-indigo-600 transition-colors" title="Émojis">
                                <i class="fas fa-smile text-sm sm:text-lg"></i>
                            </button>
                        </div>
                        <button type="submit" id="send-button" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-2 sm:p-3 rounded-full hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex-shrink-0">
                            <i class="fas fa-paper-plane text-sm sm:text-base"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar - Membres -->
        <div id="sidebar" class="sidebar w-80 md:w-80 p-4 sm:p-6 overflow-y-auto">
            <!-- Header mobile avec bouton fermer -->
            <div class="flex items-center justify-between mb-4 md:hidden">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Membres ({{ salon.participants.count }})
                </h3>
                <button onclick="toggleSidebar()" class="p-2 text-gray-500 hover:text-indigo-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <h3 class="hidden md:flex text-lg font-semibold text-gray-900 dark:text-white mb-4 items-center">
                    <i class="fas fa-users text-indigo-600 dark:text-indigo-400 mr-2"></i>
                    Membres ({{ salon.participants.count }})
                </h3>
                
                <div class="space-y-3">
                    {% for participant in salon.participants.all %}
                    <div class="flex items-center space-x-2 sm:space-x-3 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer">
                        <div class="relative flex-shrink-0">
                            <img src="{% if participant.userprofile %}{{ participant.userprofile.get_avatar_url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}" 
                                 alt="{{ participant.username }}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full">
                            <div class="absolute -bottom-1 -right-1 w-2 h-2 sm:w-3 sm:h-3 online-indicator rounded-full border-2 border-white"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate">
                                {{ participant.get_full_name|default:participant.username }}
                                {% if participant == user %}
                                <span class="text-xs text-indigo-600 dark:text-indigo-400">(Vous)</span>
                                {% endif %}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">En ligne</p>
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <button class="p-1 text-gray-400 hover:text-indigo-600 transition-colors" title="Message privé">
                                <i class="fas fa-envelope text-xs"></i>
                            </button>
                            <button class="p-1 text-gray-400 hover:text-indigo-600 transition-colors" title="Profil">
                                <i class="fas fa-user text-xs"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Informations du salon -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-info-circle text-indigo-600 dark:text-indigo-400 mr-2"></i>
                    À propos
                </h3>
                
                <div class="space-y-3">
                    {% if salon.description %}
                    <div class="bg-white/50 dark:bg-gray-700/50 rounded-lg p-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300">{{ salon.description }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="bg-white/50 dark:bg-gray-700/50 rounded-lg p-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Créé le</span>
                            <span class="text-gray-900 dark:text-white">{{ salon.cree_le|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white/50 dark:bg-gray-700/50 rounded-lg p-3">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Messages</span>
                            <span class="text-gray-900 dark:text-white">{{ messages.count }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="space-y-2">
                <button type="button" class="w-full flex items-center space-x-3 p-3 text-left text-gray-700 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50 rounded-lg transition-colors" onclick="openInviteModal()">
                    <i class="fas fa-user-plus text-indigo-600 dark:text-indigo-400"></i>
                    <span>Inviter des membres</span>
                </button>
                
                <button class="w-full flex items-center space-x-3 p-3 text-left text-gray-700 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                    <i class="fas fa-bell text-indigo-600 dark:text-indigo-400"></i>
                    <span>Notifications</span>
                </button>
                
                <button class="w-full flex items-center space-x-3 p-3 text-left text-gray-700 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-gray-700/50 rounded-lg transition-colors">
                    <i class="fas fa-search text-indigo-600 dark:text-indigo-400"></i>
                    <span>Rechercher dans le salon</span>
                </button>
                
                <button class="w-full flex items-center space-x-3 p-3 text-left text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Quitter le salon</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'invitation de membres -->
<div id="inviteMembersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Inviter des Membres</h3>
            <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form method="post" action="{% url 'chat:invite_members' salon.id %}">
            {% csrf_token %}
            <div class="mb-4">
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="invite-search-input"
                           class="w-full pl-10 pr-4 py-2 sm:py-3 rounded-2xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm sm:text-base text-gray-900 placeholder-gray-500"
                           placeholder="Rechercher un membre...">
                </div>

                {{ invite_form.users_to_invite.label_tag }}
                <div id="invite-members-list" class="mt-2 space-y-2 max-h-60 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-3">
                    {% for checkbox in invite_form.users_to_invite %}
                        <div class="flex items-center invite-member-item">
                            {{ checkbox.tag }}
                            <label for="{{ checkbox.id_for_label }}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                {{ checkbox.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
                {% if invite_form.users_to_invite.errors %}
                    <div class="text-red-500 text-sm mt-2">
                        {% for error in invite_form.users_to_invite.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="flex space-x-3">
                <button type="button" 
                        onclick="closeInviteModal()"
                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Annuler
                </button>
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-all duration-300">
                    Inviter
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Variables globales
const salonId = "{{ salon.id }}";
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendMessageUrl = "{% url 'chat:envoyer_message' salon.id %}";
const messagesApiUrl = "{% url 'chat:messages_api' salon.id %}"; // URL pour l'API de récupération des messages
const currentUserUsername = "{{ user.username }}";
const currentUserAvatar = "{% if user.userprofile %}{{ user.userprofile.get_avatar_url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}";

let lastMessageTimestamp = "{% if messages %}{{ messages.last.timestamp|date:'c' }}{% else %}null{% endif %}"; // Timestamp du dernier message affiché

// Fonction pour récupérer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    messageInput.focus();

    // Gestion de l'envoi de messages via AJAX
    document.getElementById('message-form').addEventListener('submit', async function(e) {
        e.preventDefault(); // Empêche le rechargement de la page
        const messageText = messageInput.value.trim();

        if (messageText) {
            const formData = new FormData();
            formData.append('contenu', messageText);

            try {
                const response = await fetch(sendMessageUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                    },
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Erreur lors de l\'envoi du message:', errorData.error);
                    // Afficher une notification d'erreur à l'utilisateur si nécessaire
                    return;
                }

                const data = await response.json();
                if (data.status === 'success' && data.message) {
                    // Ajouter le message envoyé par l'utilisateur immédiatement
                    addMessage(data.message);
                    messageInput.value = ''; // Effacer l'input
                    lastMessageTimestamp = data.message.timestamp; // Mettre à jour le timestamp
                }
            } catch (error) {
                console.error('Erreur réseau ou autre:', error);
            }
        }
    });

    // Démarrer le polling des messages
    setInterval(pollMessages, 3000); // Toutes les 3 secondes

    // Logique de recherche dans la modale d'invitation
    const inviteSearchInput = document.getElementById('invite-search-input');
    if (inviteSearchInput) {
        inviteSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const memberItems = document.querySelectorAll('#invite-members-list .invite-member-item');
            
            memberItems.forEach(item => {
                const label = item.querySelector('label');
                if (label) {
                    const username = label.textContent.toLowerCase();
                    if (username.includes(searchTerm)) {
                        item.style.display = 'flex'; // Afficher l'élément
                    } else {
                        item.style.display = 'none'; // Masquer l'élément
                    }
                }
            });
        });
    }
});

// Fonction pour ajouter un message au DOM
function addMessage(messageData) {
    const messageDiv = document.createElement('div');
    // Déterminer si le message est de l'utilisateur actuel
    const isOwn = (messageData.auteur_username === currentUserUsername);
    
    messageDiv.className = `message-bubble flex items-start space-x-2 sm:space-x-3 ${isOwn ? 'justify-end' : ''}`;
    
    const avatarSrc = isOwn 
        ? currentUserAvatar
        : messageData.auteur_avatar_url || "{% static 'images/default_avatar.png' %}";
    
    const messageTime = new Date(messageData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const authorName = isOwn ? "Vous" : messageData.auteur_username;

    if (isOwn) {
        messageDiv.innerHTML = `
            <div class="text-right">
                <div class="flex items-center justify-end space-x-1 sm:space-x-2 mb-1">
                    <span class="text-xs text-gray-500 dark:text-gray-400">${messageTime}</span>
                    <span class="text-sm font-medium text-gray-900 dark:text-white">${authorName}</span>
                </div>
                <div class="message-own text-white rounded-2xl rounded-tr-md p-2 sm:p-3 shadow-sm inline-block max-w-xs sm:max-w-sm break-words">
                    <p class="text-sm sm:text-base">${messageData.contenu}</p>
                </div>
            </div>
            <img src="${avatarSrc}" alt="Votre avatar" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex-shrink-0">
        `;
    } else {
        messageDiv.innerHTML = `
            <img src="${avatarSrc}" alt="${authorName}" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex-shrink-0">
            <div class="flex-1 min-w-0">
                <div class="flex items-center space-x-1 sm:space-x-2 mb-1">
                    <span class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white truncate">${authorName}</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">${messageTime}</span>
                </div>
                <div class="message-other text-gray-800 dark:text-gray-200 rounded-2xl rounded-tl-md p-2 sm:p-3 shadow-sm max-w-xs sm:max-w-md break-words">
                    <p class="text-sm sm:text-base">${messageData.contenu}</p>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Fonction pour récupérer les nouveaux messages
async function pollMessages() {
    try {
        let url = messagesApiUrl;
        if (lastMessageTimestamp && lastMessageTimestamp !== 'null') {
            url += `?since=${lastMessageTimestamp}`; // Envoyer le timestamp du dernier message connu
        }

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken, // CSRF est aussi nécessaire pour les GET si la vue est décorée
            },
        });

        if (!response.ok) {
            console.error('Erreur lors de la récupération des messages:', response.statusText);
            return;
        }

        const data = await response.json();
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                // Vérifier si le message n'est pas déjà affiché (utile si le polling est rapide)
                // Ou si le message n'est pas celui que l'utilisateur vient d'envoyer (pour éviter les doublons)
                // Pour simplifier, on ajoute tous les messages reçus par l'API
                addMessage(msg);
            });
            // Mettre à jour le timestamp du dernier message
            lastMessageTimestamp = data.messages[data.messages.length - 1].timestamp;
        }
    } catch (error) {
        console.error('Erreur réseau lors du polling des messages:', error);
    }
}


function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Fonctions pour la modale d'invitation
function openInviteModal() {
    document.getElementById('inviteMembersModal').classList.remove('hidden');
    document.getElementById('inviteMembersModal').classList.add('flex');
    // Réinitialiser la recherche et afficher tous les membres à l'ouverture
    const inviteSearchInput = document.getElementById('invite-search-input');
    if (inviteSearchInput) {
        inviteSearchInput.value = '';
        const memberItems = document.querySelectorAll('#invite-members-list .invite-member-item');
        memberItems.forEach(item => {
            item.style.display = 'flex';
        });
    }
}

function closeInviteModal() {
    document.getElementById('inviteMembersModal').classList.add('hidden');
    document.getElementById('inviteMembersModal').classList.remove('flex');
}

// Fermer le modal en cliquant à l'extérieur
document.getElementById('inviteMembersModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeInviteModal();
    }
});


// Fonction pour toggle la sidebar sur mobile
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

// Fermer la sidebar quand on redimensionne vers desktop
window.addEventListener('resize', function() {
    if (window.innerWidth >= 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
    }
});
</script>
{% endblock %}